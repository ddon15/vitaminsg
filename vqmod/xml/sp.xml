<modification>
    <id>Special Promotions</id>
    <version>1.0</version>
    <vqmver>1.2.3</vqmver>
    <author>Malcolm</author>

    <file name="catalog/controller/total/coupon.php" error="skip">
        <operation error="skip">
            <search position="before"><![CDATA[if (isset($this->request->post['coupon'])) {]]></search>
            <add><![CDATA[
                if ($this->config->get('special_promotions_key') && $this->config->get('special_promotions_status')) {
                    $this->request->post['coupon'] = empty($this->request->post['coupon']) ? '' : $this->request->post['coupon'];
                    $this->load->model('checkout/special_promotions');
                    $coupon_check = $this->model_checkout_special_promotions->checkCoupon($this->request->post['coupon']);
                    if ($coupon_check) {
                        $this->session->data['coupon'] = $this->request->post['coupon'];
                        if ($this->config->get('special_promotions_multiply_coupons')) {
                            if (empty($this->session->data['special_promotions_coupon']) || !is_array($this->session->data['special_promotions_coupon'])) {
                                $this->session->data['special_promotions_coupon'] = array();
                            }
                            if (!in_array($this->request->post['coupon'], $this->session->data['special_promotions_coupon'])) {
                                $this->session->data['special_promotions_coupon'][] = $this->request->post['coupon'];
                            }
                        } else {
                            $this->session->data['special_promotions_coupon'] = array($this->request->post['coupon']);
                        }
                        $this->session->data['success'] = $this->language->get('text_success');
                        $json['redirect'] = $this->url->link('checkout/cart', '', 'SSL');
                        $this->load->library('json');
                        $this->response->setOutput(Json::encode($json));
                        unset($this->request->post['coupon']);
                    }

                    if (!empty($this->session->data['special_promotions']) && $this->config->get('special_promotions_disable_oc_coupons')) {
                        $this->request->post['coupon'] = '';
                        if (isset($this->session->data['coupon'])) {
                            unset($this->session->data['coupon']);
                        }
                    }
                }
                ]]></add>
        </operation>
    </file>

    <file name="catalog/controller/checkout/cart.php" error="skip">
        <operation error="skip">
            <search position="after"><![CDATA[private function validateCoupon() {]]></search>
            <add><![CDATA[
                if ($this->config->get('special_promotions_key') && $this->config->get('special_promotions_status')) {
                    $this->load->model('checkout/special_promotions');
                    $coupon_check = $this->model_checkout_special_promotions->checkCoupon($this->request->post['coupon']);
                    if ($coupon_check) {
                        if (!$this->config->get('special_promotions_disable_oc_coupons') || empty($this->session->data['special_promotions'])) {
                            $this->session->data['coupon'] = $this->request->post['coupon'];
                        }
                        if ($this->config->get('special_promotions_multiply_coupons')) {
                            if (empty($this->session->data['special_promotions_coupon']) || !is_array($this->session->data['special_promotions_coupon'])) {
                                $this->session->data['special_promotions_coupon'] = array();
                            }
                            if (!in_array($this->request->post['coupon'], $this->session->data['special_promotions_coupon'])) {
                                $this->session->data['special_promotions_coupon'][] = $this->request->post['coupon'];
                            }
                        } else {
                            $this->session->data['special_promotions_coupon'] = array($this->request->post['coupon']);
                        }
                        return true;
                    }

                    if (!empty($this->session->data['special_promotions']) && $this->config->get('special_promotions_disable_oc_coupons')) {
                        if (isset($this->request->post['coupon'])) {
                            $this->request->post['coupon'] = '';
                        }
                        if (isset($this->session->data['coupon'])) {
                            unset($this->session->data['coupon']);
                        }
                    }
                }
                ]]></add>
        </operation>
    </file>

    <file name="admin/view/template/common/header.tpl">
        <operation error="skip">
            <search position="after"><![CDATA[<li><a href="<?php echo $report_purchased; ?>"><?php echo $text_report_purchased; ?></a></li>]]></search>
            <add><![CDATA[
                <?php if(!empty($text_special_promotions)) { ?>
                <li><a href="<?php echo $report_special_promotions; ?>"><?php echo $text_special_promotions; ?></a></li>
                <?php } ?>
                ]]></add>
        </operation>
    </file>

</modification>